#!/usr/bin/env zsh
#e ZSH globbing to list (on stdout) all but the most recent 10000
# directories in the analyses directory. If there are fewer than 10000
# directories, then 0 directories will be listed on stdout. If an argument is
# given, it is used instead of 10000.
#
# The output of this program can be passed to xargs(1) or parallel(1) in order
# to delete or move the directories listed on the output. E.g.:
#
# ./utils/analyses_cleanup 20000 | parallel -j4 curl -s -o /dev/null http://localhost:8090/tasks/delete/{}
#
# ...will delete all but the 20000 most recently-created tasks. Running this
# repeatedly will maintain the invariant that there are no more than 20000
# tasks by deleting the oldest.
#
# Author: tcreech

# Path fixup: figure out where we are and where the relevant analyses directory is.
SCRIPTPATH=${0:A:h}
ANALYSESDIR=$SCRIPTPATH/../storage/analyses
pushd $ANALYSESDIR

# Some magic: generate the negative of the number given, even if the number
# given was already negative.
SAVENUM=$(( 0 - (${1-500} + 1) ))

# Further magic: match all but the most recent SAVENUM directories in the
# current directory. (Note that SAVENUM here is the negative of the argument,
# if given.)
for i in *(/Oc[1,$SAVENUM]N); do
    if [ -f $i/reports/report.json ];
    then
        printf "%s\n" $i
    fi
done

