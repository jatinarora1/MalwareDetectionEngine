from lib.cuckoo.common.abstracts import Signature

class Static_PDF(Signature):
    name = "static_pdf"
    description = "The PDF file contains suspicious characteristics"
    severity = 2
    weight = 0
    categories = ["pdf","static"]
    authors = ["Kevin Ross","KillerInstinct"]
    minimum = "1.3"

    def on_complete(self):

        exploit = 0

        if True and "pdf" in self.get_results("static",{}):
            if "PDF" in self.get_results("target",{})["file"]["type"]:            
                if "Data After EOF" in self.get_results("static",{})["pdf"]["Info"]:
                    if self.get_results("static",{})["pdf"]["Info"]["Data After EOF"] != "0":
                        self.mark_ioc("data_after_eof" , "PDF contains data after the declared end of file" )
                        self.weight += 1
                        self.severity = 3

                if "Keywords" in self.get_results("static",{})["pdf"]:
                    if "/Page" in self.get_results("static",{})["pdf"]["Keywords"]:
                        num_pages = self.get_results("static",{})["pdf"]["Keywords"]["/Page"]
                        num_stream = self.get_results("static",{})["pdf"]["Keywords"]["stream"]
                        num_obj = self.get_results("static",{})["pdf"]["Keywords"]["obj"]
                        if num_pages > 10 and num_stream < 10 and num_obj < 35:
                            self.mark_ioc("content_anomaly" , "PDF is a %s page document yet contains a low amount of objects and streams indicating a possible lack of content"  % (num_pages))
                            self.weight += 1

                if "Keywords" in self.get_results("static",{})["pdf"]:
                    if "/Page" in self.get_results("static",{})["pdf"]["Keywords"]:
                        num_pages = self.get_results("static",{})["pdf"]["Keywords"]["/Page"]
                        if num_pages == 1:
                            self.mark_ioc("single_page" , "PDF contains one page. Many malicious PDFs only have one page." )
                            self.weight += 1

                if "Keywords" in self.get_results("static",{})["pdf"]:
                    if "/JavaScript" in self.get_results("static",{})["pdf"]["Keywords"] or "/JS" in self.get_results("static",{})["pdf"]["Keywords"]:
                        if self.get_results("static",{})["pdf"]["Keywords"]["/JavaScript"] > 0 or self.get_results("static",{})["pdf"]["Keywords"]["/JS"] > 0:
                            self.mark_ioc("javascript_object" , "PDF contains JavaScript usage" )
                            self.weight += 1

                if "Keywords" in self.get_results("static",{})["pdf"]:
                    if "/XFA" in self.get_results("static",{})["pdf"]["Keywords"]:
                        if self.get_results("static",{})["pdf"]["Keywords"]["/XFA"] > 0:
                            self.mark_ioc("xfa_object" , "Contains an XFA forms object" )
                            self.weight += 1

                # Specific Exploit Detection (this will be expanded upon & generic detections added too)
                if "Keywords" in self.get_results("static",{})["pdf"]:
                    if "/Colors > 2^24" in self.get_results("static",{})["pdf"]["Keywords"]:
                        if self.get_results("static",{})["pdf"]["Keywords"]["/Colors > 2^24"] == 1:
                            self.mark_ioc("cve2009_3459" , "Colors greater than 2 ^ 24 heap overflow exploit" )
                            exploit += 1

            if exploit > 0:
                self.description += " and contains possible exploit code."
                self.severity = 3
                self.weight += 1
                          
        if self.weight:
            return True

        return False
