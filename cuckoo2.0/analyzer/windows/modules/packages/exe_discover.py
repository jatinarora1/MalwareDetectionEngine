# Copyright (C) 2010-2013 Claudio Guarnieri.
# Copyright (C) 2014-2015 Cuckoo Foundation.
# This file is part of Cuckoo Sandbox - http://www.cuckoosandbox.org
# See the file 'docs/LICENSE' for copying permission.

import os
import shlex
import logging
import subprocess
import tempfile
import time

from lib.core.config import Config
from lib.common.abstracts import Package
from lib.api.process import Process

pid_file = "C:\\Dlls\\pid.txt"

pid_out_file = "C:\\Dlls\\pid_out.txt"

log = logging.getLogger(__name__)

class Exe(Package):
    """EXE analysis package."""

    def start(self, path):
        args = self.options.get("arguments", "")

        cfg = Config("analysis.conf")
	name, ext = os.path.splitext(path)
        if not ext:
            new_path = name + ".exe"
            os.rename(path, new_path)
            path = new_path

        
        # Get the arguments
        free = self.options.get("free", False)
        no_inject = self.options.get("no_inject", False)
	#dbi = self.options.get("dbi", None)
        timeout = self.options.get("timeout", 20)
        cuckoomon = self.options.get("cuckoomon", None)
        dis = self.options.get("dis", None)
        eep = self.options.get("eep", None)
        detach = self.options.get("detach", None)
        libdft = self.options.get("libdft", None)
        #path_vm = self.options.get("path_vm", "")


	dumpBinCmd = "C:\\Dlls\\dumpbin.exe /dependents " + path + " > C:\\Dlls\\LWR_outDumpBin.txt"
        log.warning(dumpBinCmd)
        subprocess.Popen(dumpBinCmd,shell=True)

        dv_args1 = ["-c", "C:\\Dlls\\dvasion_vm.dll"]
        
        dv_args1.append("--")
        dv_args1.append(path)
        dv_args1.append((args))        
        
	#Injection starts here
	return self.execute(path="C:\\Dlls\\discover\\bin32\\drrun.exe", args=dv_args1)
	
