# Copyright (C) 2010-2013 Claudio Guarnieri.
# Copyright (C) 2014-2016 Cuckoo Foundation.
# This file is part of Cuckoo Sandbox - http://www.cuckoosandbox.org
# See the file 'docs/LICENSE' for copying permission.

import logging
import os
import mmap
import re
import sys
import subprocess
import time


from lib.common.abstracts import Package



URL_REGEX = (
      # HTTP/HTTPS.
      "(https?:\\/\\/)"
      "((["
      # IP address.
      "(?:[0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\."
      "(?:[0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\."
      "(?:[0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\."
      "(?:[0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])]|"
      # Or domain name.
      "[a-zA-Z0-9\\.-]+)"
      # Optional port.
      "(\\:\\d+)?"
      # URI.
      "(/[\\(\\)a-zA-Z0-9_:%?=/\\.-]*)?"
  )




log = logging.getLogger(__name__)


#Run a particular package on current file 
def run_package(basepack,curPack,filename):
         package_name = "modules.packages.%s" %curPack
         try:
                 __import__(package_name,globals(),locals(),["dummy"],-1)
                 log.warning("Package imported: %s",package_name)
         except ImportError:
                 log.warning("Failed to import package %s",package_name)
 
 
         # Initialize the package parent abstract.
         Package()
 
         #numPacks = len(Package.__subclassses__())
         #log.warning("Number of packages %s",numPacks)
         for cls in Package.__subclasses__():
                 #log.warning("Class %s",cls.__name__)
                 if str.lower(cls.__name__) in curPack:
                         package = cls(basepack.options)
 
                         try:
                                 log.warning("Starting package %s",cls.__name__)
                                 package.start(filename)
                         except Exception as e:
                                 log.warning("Failed to start package on file with error %s: %s: %s ",
                                             package_name,filename,e)

