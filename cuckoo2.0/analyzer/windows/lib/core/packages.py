# Copyright (C) 2010-2013 Claudio Guarnieri.
# Copyright (C) 2014-2015 Cuckoo Foundation.
# This file is part of Cuckoo Sandbox - http://www.cuckoosandbox.org
# See the file 'docs/LICENSE' for copying permission.
from zipfile import ZipFile, BadZipfile



def has_com_exports(exports):
    com_exports = [
        "DllInstall",
        "DllCanUnloadNow",
        "DllGetClassObject",
        "DllRegisterServer",
        "DllUnregisterServer",
    ]

    for name in com_exports:
        if name not in exports:
            return False
    return True

# Is this a docx/pptx/xlsx file?
def check_office_file(target):
	namelist = []
	pkg_type = "zip"
	try:
            with ZipFile(target, "r") as archive:
                namelist = archive.namelist()
        except BadZipfile:
	    	# Invalid zip file, just return "Zip"
		return "zip"
	if (namelist):
		if ("_rels/.rels" in namelist and 
		    "[Content_Types].xml" in namelist):
			# This is most likely an Open Office XML document (docx/pptx/xlsx/etc)
			# Choose the appropriate file type based on this
			if ("word/document.xml" in namelist):
				# Word Document
				pkg_type = "doc"
			elif ("ppt/presentation.xml" in namelist):
				# Powerpoint Presentation
				pkg_type = "ppt"
			elif ("xl/workbook.xml" in namelist):
				# EXCEL Document
				pkg_type = "xls"

	return pkg_type
	

def choose_package(file_type, file_name, exports, target):
    """Choose analysis package due to file type and file extension.
    @param file_type: file type.
    @param file_name: file name.
    @return: package name or None.
    """
    if not file_type:
        return None

    file_name = file_name.lower()

    if "DLL" in file_type:
        if file_name.endswith(".cpl"):
            return "cpl"
        elif has_com_exports(exports):
            return "com"
        else:
            return "dll"
    elif "PE32" in file_type or "MS-DOS" in file_type:
        return "exe"
    elif "PDF" in file_type or file_name.endswith(".pdf"):
        return "pdf"
    elif file_name.endswith(".pub"):
        return "pub"
    elif "Rich Text Format" in file_type or \
            "Microsoft Word" in file_type or \
            "Microsoft Office Word" in file_type or \
            file_name.endswith((".doc", ".docx", ".rtf", ".docm")):
        return "doc"
    elif "Microsoft Office Excel" in file_type or \
            "Microsoft Excel" in file_type or \
            file_name.endswith((".xls", ".xlsx")):
        return "xls"
    elif "Microsoft PowerPoint" in file_type or \
            file_name.endswith((".ppt", ".pptx", ".pps", ".ppsx", ".pptm", ".potm", ".potx", ".ppsm")):
        return "ppt"
    elif "OOXML" in file_type:
	return check_office_file(target)
    elif "HTML" in file_type or file_name.endswith((".htm", ".html")) or file_type=="data":
        return "ie"
    elif file_name.endswith(".jar"):
        return "jar"
    elif "Zip" in file_type or "zip" in file_type:
	return check_office_file(target)

    elif file_name.endswith((".py", ".pyc")) or "Python script" in file_type:
        return "python"
    elif file_name.endswith(".vbs"):
        return "vbs"
    elif file_name.endswith((".js", ".jse")):
        return "js"
    elif file_name.endswith(".msi"):
        return "msi"
    elif file_name.endswith(".ps1"):
        return "ps1"
    elif file_name.endswith(".wsf"):
        return "wsf"
    else:
        return "generic"
