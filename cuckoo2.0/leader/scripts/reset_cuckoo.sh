#!/bin/bash
# Requires that cuckoo is running under cuckoo_wrapper.py

API_PORT=8090

while [[ $# -gt 0 ]]; do
        arg="$1"
        case $arg in
                -p) API_PORT="$2";  shift ;;       #specify number of Virtual Machines
                *) # don't do anything ;;
        esac
        shift
done

echo "GOT PORT $API_PORT"

num_running=99999
re="\"running\": ([0-9]*)"
api_call=$(curl -s http://localhost:$API_PORT/cuckoo/status | grep "\"running\": [0-9]")

if [[ $api_call =~ $re ]] ; then 
	num_running=${BASH_REMATCH[1]}
else
	echo "Regular expression failed! Check that api.py is running on port $API_PORT"
	exit 1
fi
if [ "$num_running" == "0" ] ; then
	sudo pkill -f "cuckoo_wrapper.py -p $API_PORT"
	exit 0
fi

exit 1
