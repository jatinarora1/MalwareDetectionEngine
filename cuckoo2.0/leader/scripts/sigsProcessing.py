#!/usr/bin/python

#This script takes a list of json files, and tries find statistics on that data
# How many are new sigs, which are most common sigs etc

import sys
from collections import defaultdict

from MalwareSampleReport import MalwareSampleReport

numFiles = 0
numFailFiles = 0
numOrigSigs = 0
numNewSigs = 0

origSigs = {}
newSigs = {}

#File containing list of cuckoo reports
inFile = sys.argv[1]



def dumpSigs(inSigs):
	#We create a reverse dictionary that is based on number which can be duplicated
	tempDict = defaultdict(list)	

	for key,value in inSigs.items():
		tempDict[value].append(key)
	

	for tempkey in sorted(tempDict,reverse=True):
		values = tempDict[tempkey]
		for tempvalue in values:
			print (tempkey , tempvalue)
		

reports = [line.rstrip('\n') for line in open(inFile)]

#Iterate over the reports
for report in reports:
	numFiles=numFiles+1

	try:
		sample = MalwareSampleReport(report)
		sigs = sample.get_all_signatures()
		for sig in sigs:
			curSigDesc = sig["description"]
			if "new_vs_cuckoo" in sig:
				numNewSigs=numNewSigs+1
				if curSigDesc in newSigs:
					newSigs[curSigDesc]=newSigs[curSigDesc]+1
				else:
					newSigs[curSigDesc]=1
			else:
				numOrigSigs=numOrigSigs+1
				if curSigDesc in origSigs:
					origSigs[curSigDesc]=origSigs[curSigDesc]+1
				else:
					origSigs[curSigDesc]=1
	
	except:
		print "Failed to process:" + report
		numFailFiles=numFailFiles+1	
	


print "Num files: " + str(numFiles)
print "Num Successful files: " + str(numFailFiles)
print "Num Orig Sigs: " + str(numOrigSigs)
print "Num New Sigs: " + str(numNewSigs)
print "Total Sigs: " + str(numOrigSigs + numNewSigs)


print "\n\n"
print "---------------------------------------------------"
print "Original Signatures :                              "
print "---------------------------------------------------"

dumpSigs(origSigs)


print "\n\n"
print "---------------------------------------------------"
print "New Signatures :                                   "
print "---------------------------------------------------"

dumpSigs(newSigs)


